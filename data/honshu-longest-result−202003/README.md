# JR最長O型きっぷを求めたメモ （2020年3月版）

## 概要

* JR最長O型きっぷルートを求める場合、Lee型における[孤立ループ除去](https://www.swa785.net/lop/lop_ip03.html#loopelim)はそのまま使えない
    * 最長O型ルートじたいが「孤立ループ」そのものだから
* もちろんこれについては、O型専用の孤立ループ除去（最長のループのみ残して他を除去する）によって解消はできる
* しかし実際に全国規模で計算をさせると、スクリプトを24時間以上動かしっぱなしにしても最長解が得られないことがある
* また、JRグループにおけるO型きっぷルートは、発駅＝着駅を[旅客営業規則第69条・経路特定区間](https://ja.wikipedia.org/wiki/%E7%B5%8C%E8%B7%AF%E7%89%B9%E5%AE%9A%E5%8C%BA%E9%96%93)の長い方のルート内の駅に設定することで、運賃計算キロを延長することができるため、このことも最長ルート計算において考慮しなければならない
* 本稿は、これらの条件を考慮した計算テクニックを、2020年3月現在のJR路線網に即して解説するものである

## 戦略

* 最長O型ルートは、「本州内の、行き止まり枝線を除外した路線」（以下、「本州網」とする）のみを網として計算すれば算出できる
    * JR（に限らず、国内の鉄道路線網での）最長O型ルートは、本州内で完結する
    * また、最長O型ルートは、行き止まり枝線（いわゆる「盲腸線」（不正確な日本語））を通らないことも自明
* しかし、「本州網」ぜんたいについての最長O型ルートを求めようとすると、孤立ループが爆発的に発生し、短い時間で最適解を得ることが不可能である
* そのため、以下のとおり、問題を分割して求めることにする
    1. まず、経路特定区間については「規則どおり」として計算するものとし、経路データを構成する
    1. 「本州網」を以下の3駅をもって東日本網・西日本網に2分割する
        1. 黒部宇奈月温泉駅
        1. 中津川駅
        1. 三河安城駅
    1. 東日本網・西日本網それぞれについて、分割駅どうしを結ぶLee型最長ルートを計算し合算する
        1. 黒部宇奈月温泉-東日本網-中津川 + 中津川-西日本網-黒部宇奈月温泉
        1. 黒部宇奈月温泉-東日本網-三河安城 + 三河安城-西日本網-黒部宇奈月温泉
        1. 中津川-東日本網-三河安城 + 三河安城-西日本網-中津川
    1. また、ねんのため、東日本網・西日本網それぞれで完結するO型最長ルートを計算する
    1. 得られた5つのルートのうち、最長のものが、（経路特定区間を考慮しない）JR最長O型きっぷのルートとなる
* 最後に、以下のとおり、経路特定区間を考慮する
    1. 経路の運賃計算キロに差異があるすべての経路特定区間について、それぞれ、「必ず1度通過する」という制約をつけてLeeの組み合わせとなる3経路を計算し、そのうちの最長のものが、「線内発着での経路特定区間の回避による最長O型ルートの運賃計算キロ」となる
    1. 1.のうちの最長のものが「真のJR最長O型きっぷのルート」となる

## 計算の前準備

### 計算対象範囲の刈り込み

最長O型ルートは、「本州内の、行き止まり枝線を除外した路線」（以下、「本州網」とする）のみを網とすれば、算出できます。

まず、本州から北海道・四国・九州に至るルートはそれぞれ1経路のみなので、それらを利用するルートは決してO型になりません。

* これはたとえば、丸亀駅（JR四国）と茶屋町駅（JR西日本）をいずれも通過するO型ルートが存在するかどうかを考えればわかります。四国から本州に本四備讃線を経由して入ると、本州から四国に戻ることができません。四国と本州の間の経路は本四備讃線しかなく、それをもう1回通過しているためです。

* なお、海峡線は書類上「旅客営業中」であり、かつ[旅客営業規則第16条の4](https://www.jreast.co.jp/ryokaku/02_hen/01_syo/01_setsu/03.html)により北海道新幹線とは「新在別線」であることから、「ルートは2本である」とみなすことは可能です。しかし現実に海峡線を通過し木古内駅で北海道新幹線に乗り継ぐ普通乗車券が発売されることはありえず、「じっさいに旅行する」という前提での最長ルートの計算からは除外してよいでしょう。

また、行き止まり枝線を通過することもありません。

* 理由は前述の丸亀・茶屋町と同じです。

そしてその結果、JR（に限らず、国内の鉄道路線網での）最長O型ルートは、本州内で完結することがわかります。

* 今回は示しませんが、北海道・四国・九州それぞれの島内で完結する最長O型ルートは、本州内で完結する最長O型ルートよりもはるかに短くなります。

### 経路特定区間の考慮の準備

経路特定区間は、以下の区間において、いずれかの経路のみを1度だけ通過する場合、指定された経路（現在、すべて、長くない方）の営業キロ・運賃計算キロを運賃・料金の計算に用いる、というものです。

すなわち、最長片道ルートを算出した際に、この条件を満たす経路が存在した場合、営業キロ・運賃計算キロは「条文で指定されている長くない方」によって強制計算されてしまいます。

* じっさいの乗車は、旅客営業規則第158条により、「短くない」経路をう回して行えるため、最長切符を購入し乗車する場合の「実乗最長」をめざす行程については、この規則は関係しません。

この「長くない方を強制適用する」という経路特定区間を、整数計画法の制約式にそのまま実装することは、まさに葛西さんが実装された「工夫」の範疇となります。

* たとえば、旅客営業規則第69条第1項(3)について、制約式を考えてみましょう。
    * 赤羽以遠（尾久、東十条又は十条方面）の各駅と、大宮以遠（土呂、宮原又は日進方面）の各駅との相互間
        * 戸田公園・与野本町経由東北本線
        * ○川口・浦和経由東北本線
    * 添付の `edges_east_2020.csv` により定義された0-1枝変数では、これらは以下のとおりとなる
        * 通称埼京線: `e163`, `e081`
        * 通称京浜東北線: `e162`, `e080`
    * これらのうち、「どちらかのみを通過する＝赤羽-大宮間を通る」ことが経路特定区間の成立条件であるから、以下の制約式が成り立つように思える。
        * `e163 + e081 <= 1;`
    * しかしこれは誤りである。なぜなら、以下のルートには[旅客営業取扱基準規程](http://www.desktoptetsu.com/ryoki/kijunkitei.htm)第109条の「2度通過」条項が適用され、経路どおりの乗車券が発売されるからである。この経路が上の制約式を満たさないことは自明である。
        * `e163 + e081 + e808 = 3;`
    * 上記の件も考慮すると、制約論理は以下すべてを満たすもので必要十分ではある。これは「埼京線を通過したら、必ず京浜東北線の枝を1つ以上通過しなければならない」ということを意味する。ただしthen部分の値が2になることは、「この区間の最長O型ルートを求める」というものでもない限りはありえないが）
        * `e163 + e081 = 2; ならば e162 + e080 >= 1;`
    * この制約論理は、以下の制約式に変換できる（葛西さんご本人にヒントをいただきました。ありがとうございます）
        * `e163 + e081 - e162 - e080 <= 1`
        * すべての枝変数は0-1値なので、上記の式が「成り立たない」のは、「 `e163` と `e081` が `1` 」かつ「 `e162` と `e080` が `0` 」の場合のみとなる。これはまさに「通過時に許されていない「長い方の経路」」そのものであり、上記の式が成り立つことが経路特定区間と合致する。

この制約式の考え方を踏まえ、最長O型ルート計算（後述となりますが、純O型ルート、および端点が指定されたLee型ルートの計算と同値です）の方針を、以下のとおりと定めました。

1. 全国9箇所に設定されている経路特定区間のうち、北海道内の第1号（大沼-森) 、どちらを経由してもキロ数が変わらない第5号（総武・京葉）については、考慮が不要である
    * 第5号は元来、京葉線全通時に旅客営業規則第70条・電車大環状線にこの区間を含めてしまったたために大混乱が起こり、後に70条から削除し69条に移行されたもので、キロ数の差異がないことは制度ヲタには有名です
1. 1.以外のすべての経路特定区間を規則どおりに計算する制約式を加え、最長ルートを求める
1. 1.以外のすべての経路特定区間に対し、「その区間内発着により経路特定区間の適用を回避できる」計算を行う

### 本州の分割

最長O型ルートの算出においては、「孤立ループ」をすべて除去することはできず、計算結果で複数のループを発見した場合はその中の最長のもの「以外」について除去制約式を追加して再計算する、という過程を経ています（ `loopchk.pl` 参照）。

しかし、「本州網」ぜんたいについての最長O型ルートを求めようとすると、孤立ループがあらゆる箇所に頻発し、それを禁止する制約式を加えても次々と類似の孤立ループが発生しつづけてしまいます。そのため、経験則として「短時間で最適解を得ること」は不可能です。

* 後述の東西分割によって、それぞれの範囲内の最長O型ルートは短時間で計算できています。本州の路線網との間がちょうど、複雑さが爆発する境界なのかもしれません。

このような場合に有効なのは「問題の分割」です。

じっさい、葛西さんによるJR最長片道きっぷ問題も、[全国を四島に分割し、うち三島について「本州との出入口」を起点とするL型を求める](https://www.swa785.net/lop/lop_ip04.html#strategy)ことで、問題の単純化に成功しています。

また、東西分割は、[完全に厳密ではないが整数計画法ではなく古典的な全探索で最長片道ルートを求める際にも採用されている](https://www.swa785.net/lop/lop_bk05.html)、基本的な考え方でもあります。

葛西さんが手掛けたこの分割は最長片道ルートの全探索算出のためであり、最長ルートがO型にならないことは自明なため、3経路で切断分割した場合、[いわゆる出戻り問題への対応が必要となります](https://www.swa785.net/lop/lop_bk05.html#demodori)。しかしO型の場合、3経路で2分割した両エリアにまたがるO型ルートは、3経路のうちの2経路を必ず通るLee形にしかなりません。

ここでは、目視による直感で、おおむね東西のバランスがよさそうな「中部分割」、すなわち以下のとおりに分割することとします。

* 北陸新幹線（糸魚川・富山間）（葛西さんの時代は北陸本線）
* 中央本線（塩尻・多治見間）
* 東海道本線（大府・金山間）

そして、L型とは異なり「2経路を必ず通るLee形を3通り比較すればよい」O型の場合は、ダミー線の導入は不要であり、分割は単純に途中駅で行うことが可能です。

さいわい、北陸新幹線糸魚川-富山間には黒部宇奈月温泉駅という中間駅が存在していますので、Lee型に関する計算は、次の3駅で分割すればよい、ということとなります。

* 黒部宇奈月駅
* 中津川駅
* 三河安城駅

そしてまさに、この3駅で東西に路線網を分割したものが、`edges_(east|west)_2020.csv` というデータファイルです。

## 計算の実行

### 分割O型はすぐ計算終了

まず先に、分割した路線網の東日本側（東日本網）と西日本側（西日本網）、それぞれの内部で完結する、最長O型ルートを求めます。これはいっしゅんで計算が終わります。

```
bash autoo.sh east_2020 lophonsh2020.txt
```

* 地図ファイルは東西で共通にしています。

### 意外とやっかいなLee型

次に、分割した路線網のうち、端点の3駅のうち2駅を必ず通過する、最長Lee型ルートを、各網について3通りずつ、計6回、計算します。

具体的には、これは後述の制約式手動追加でもまったく同じことを行うのですが、まずスクリプトを動かして何周かループが動作したら `Ctrl+C` でスクリプトを停め、ヒューリスティックな制約式を手書きで追加し、あらためてスクリプトを、というものです。

```
bash autolee.sh east_2020 lophonsh2020.txt
```

これを途中で止めると、`east_2020.mod` という制約式ファイルが生成されています。

* 制約式は、本来の最適解が算出されるより前であれば、どのように追加したとしても。最終解は変わりませんから、既にスクリプトが自動追加した制約式はそのままでかまいません。

制約式の手動追加は、同ファイルの

```
/* Section 9: heuristics */
```

の直後に記述してください。

### O型前提の、行き止まり枝線のない路線網に対する、Lee型特権

たとえば、「黒部宇奈月温泉と中津川を経由する」（＝その両駅で西日本網と接続する）という条件であれば、これは東日本網では「糸魚川-黒部宇奈月温泉」=`e508`と「中津川-塩尻」=`e244`の両枝を必ず通る、ということですから、制約式は

```
s.t. label: e508 + e244 = 2;
```

でよいはずです。

* 枝線変数 `exxx` は、必ず`0`か`1`ですから、「和が`2`」というロジックと同値です。

しかしここで、手動追加セクションのすぐ手前を見てください！

```
/* Section 8: isolation = 2(L), 1(Pe), 0(B,B8,O) */
s.t. SumOfIsolation:
v189 + v198 + v391 = isolation;
```

`v189`は三河安城駅であり、`v198`は中津川駅であり、そして`v391`は黒部宇奈月温泉駅なのです！

そして、この東日本網内の最長Lee型ルートは、この3駅のうちの2駅を必ず通るんだ、ということが、計算実行前の自動生成時に、すでに吐き出されているわけです！

これはまさに、今回の計算特有の、「O型特権」です。

なぜなら、前準備において、路線網のうち「行き止まり枝線」はすべて刈り取られています。その結果、路線網に登場するすべての駅＝点は、すべて2つ以上の枝を持っています。…分割した3駅をのぞいては。
Lee型最長ルートをこの路線図で求めるということは、すなわち、その3駅のうちの必ず2駅を通ることが、あらかじめ運命づけられている、ということなのです。

これがわかれば、手動制約式はさらに単純になります。

「黒部宇奈月温泉駅と中津川駅を経由する」のであれば、三河安城駅は経由しない。
この制約式は、以下のとおりです。

```
s.t. heur_cond_12: v189 = 0;
```

* ラベルとして、スクリプトが自動付加するものに準じ、「1駅めと2駅めを通る条件」ということで、`heur_cond_12`としてみました。もちろんどんな名前をつけてもかまいません。

### なかなか収束しない計算に対する、手動での制約式の追加

というわけで、じっさいに前項の制約式を加え、「黒部宇奈月温泉駅と中津川駅を経由する」最長Lee型ルートを求めてみましょう。
もちろん、このリポジトリーのルートにある`README.md`のとおり、スクリプトは少し変わります。

```
bash auto.sh east_2020 Lee lophonsh2020.txt
```

しかし、結果は、なかなか収束しません。
たとえば、以下のように。

<img src="https://raw.githubusercontent.com/yonezawaizumi/lop-toolkit/master/data/honshu-longest-result%E2%88%92202003/images/image1.png" alt="2駅を短絡したルート＋多数の孤立ループ、の例" width="230" height="400">

ご覧のとおり、黒部宇奈月温泉駅と中津川駅がみごとに大糸線と篠ノ井線でショートカットされた最短Leeルートに、多数の孤立ループが追加される、という状態になっています。

これを自動運転させつづけても、「孤立ループ除去」（Lee型ですので、すべての孤立ループが除去されてから次の計算に入ります）をまず行うようで、かんじんのLee部分が「むしろ最短じゃん！」となっていることはいっこうに改善されない、という事態に陥ります。

そしてここで、この「最短Leeルート」を阻止すべく、制約式を追加します。

これはさすがに枝で考えたほうが早いでしょう。
まず、初期の条件が「黒部宇奈月温泉駅と中津川駅を通る」ですから、そこに直結する北陸新幹線と中央西線の枝は考慮不要です。
すなわち、残る2経路、「大糸線と篠ノ井線」を同時に通らなければよいわけですから、

```
s.t. heur_cond_12_1: e242 + e243 <= 1;
```

こうなります。

そして、「東日本網での黒部宇奈月温泉駅・中津川駅を通るLee形最長ルート」は、この制約式1本のみで、短時間で最適解が得られます。

もちろんそれではやはり類似の短絡パターンになることもあります（たとえば東日本網の中津川駅・三河安城駅）。その場合は適宜、固定化されたLee型短絡線を除外追加してください。

なお、**最適解が得られたそれぞれの`*.mod`ファイルは、必ずリネームして保存しておきましょう**。なぜなら、**既に最適解を得るために孤立ループを除去する制約式が自動追加されたこのファイルに、さらに次項での「経路特定区間の制約式の追加」を行うことで、計算の劇的な高速化が望める**からです。

### 計算の結果

というわけで、前項にて求めた、O型2パターン、Lee型3×2パターン、計8パターンの計算結果、これを集計します。Googleスプレッドシートで楽をしています。

| パターン | 東日本 | 西日本 | 計 |
| --- | ---: | ---: | ---: |
| 黒部宇奈月温泉・中津川 | 48468 | 31429 | 79897 |
| 黒部宇奈月温泉・三河安城 | 47550 | 31481 | 79031 |
| 中津川・三河安城 | 47776 | 32865 | 80641 |
| 域内Ｏ型 | 48310 |  | 48310 |
|  |  | 32538 | 32538 |

以上から、経路特定区間を考慮しないJR最長O型ルートは、中津川駅および三河安城駅を通過する、東西のLee型ルートを結合したルートとなることがわかりました。

## 経路特定区間の考慮

前項の結果を受けて、ここから経路特定区間を検討します。

### 前準備＆戦略

残りについて、既に結果が得られている＝孤立ループ除去制約式が書き込まれている`*.mod`ファイルに、次項で解説する制約式を加え、再計算を行うことになります。

### 経路特定区間を考慮させる制約式

いよいよ、経路特定区間を考慮させる制約式を追加していきます。

まず、「経路特定区間の2経路の途中から分岐がある場合」です。
このケースは、前項での計算時に「長くない枝」を削除していません。

例として、第3号、「赤羽-大宮間、東北本線経由と埼京線経由、単純通過時には東北本線経由で強制計算、もし埼京線内の駅を発着駅とすれば埼京線経由になるため、最長O型ルートのキロ数は計算結果よりも+9となる」の制約式を考案してみましょう。

といっても話はかんたんです。「経路特定区間を守る」制約式を否定すればよいのですから、

```
s.t. hour_touho4: e081 + e163 - e080 - e162 = 2;
```

です。

要するに、最初に加えた制約式について、1つずつ、その成約式の否定に置き換えて、再計算すればよいことになります。
もちろんこの再計算は、東日本網の接続駅の組み合わせ3パターンに対し、それぞれ実行しなければなりません。

* 言うまでもなく、これらの計算の際には、「なかなか収束しない計算に対する、手動での制約式の追加」で触れた制約式を、あわせて指定すべきです。それにより、計算はほぼ一瞬で完了します。

* 経路特定区間に関し、解釈の揺れがあり、未解決とされることがある問題があります。これについてネガティヴな解釈が成立した場合、「環状線一種となり、片道乗車券の発売条件を満たさない」ということになりますが、「もし最長ルートがそれらに抵触した場合、改めて考慮する」という方針で臨めばよいと思われます。（そしてじっさいには、このパターンは踏まれません）

    * いっぽうの経路を通過した後、他経路の駅をかすめる場合（例：新大阪→大阪→新今宮→天王寺→久宝寺→放出→京橋→尼崎。大阪-新今宮-天王寺を通過した後、京橋駅のみをかすめている）
        * 大阪-天王寺間で(環)福島駅を経由しているが、経路特定区間が適用されれば、天満駅経由での強制計算になる
        * しかし、経路を天満駅経由とすると、京橋駅で環状線一周になってしまう
        * このケースは、経路特定区間および旅基109条の制定趣旨、すなわち「2経路を1つの大きな経路とみなす、ただしそうみなすと、他方の経路中の駅に達したことで環状線一周になってしまう、よってその場合は経路特定区間とみなさないことができるようにする」、からすれば、「経路特定区間は適用しない」としかみなせない
        * しかし制定趣旨は条文内に明文化されているものではないため、「京橋駅の通過によっては旅基109条は適用されない」という解釈の余地がある


### 経路特定区間を考慮した計算の結果

同様に、他の経路特定区間について、すべて計算した結果は、以下の表となります。

| 東 経路特定区間号数 | 2 | 3 | 4 |
| --- | :---: | :---: | :---: |
| 黒部宇奈月温泉・中津川 | 48424 | 48154 | 48148 |
| 黒部宇奈月温泉・三河安城 | 47492 | 47289 | 47360 |
| 中津川・三河安城 | 47718 | 47515 | 47586 |


| 西 経路特定区間号数 | 6 | 7 | 8 | 9 |
| --- | :---: | :---: | :---: | :---: |
| 黒部宇奈月温泉・中津川 | 29150 | 31311 | 30986 | 	31602 |
| 黒部宇奈月温泉・三河安城 | 29306 | 31333 | 31038 | 31654 |
| 中津川・三河安城 | 30690 | 32717 | 32422 | 33038 |

これに、東日本網に対して考慮なしの西日本網、西日本網に対して考慮なしの東日本網を加算すると、

| 東 経路特定区間号数 | 2 | 3 | 4 |
| --- | :---: | :---: | :---: |
| 黒部宇奈月温泉・中津川 | 79853 | 79583 | 79577 |
| 黒部宇奈月温泉・三河安城 | 78973 | 78770 | 78841 |
| 中津川・三河安城 | 80583 | 80380 | 80451 |

| 西 経路特定区間号数 | 6 | 7 | 8 | 9 |
| --- | :---: | :---: | :---: | :---: |
| 黒部宇奈月温泉・中津川 | 77618 | 79779 | 79454 | 80070 |
| 黒部宇奈月温泉・三河安城 | 76856 | 78883 | 78588 | 79204 |
| 中津川・三河安城 | 78466 | 80493 | 80198 | 80814 |

というわけで、すべての経路特定区間を含むルートについて、中津川駅と三河安城駅で結合したO型ルートが最長、ということになります。

| 号 | 経路 | 結合最長O型ルート |
| :---: | --- | :---: |
| 2 | 尾久・王子 | 80583 |
| 3 | 東北・埼京 | 80380 |
| 4 | 東海道・品鶴 | 80451 |
| 6 | 北陸・湖西 | 78466 |
| 7 | 大阪環状 | 80493 |
| 8 | 山陽・呉 | 80198 |
| 9 | 山陽・岩徳 | 80814 |

## 最終チェック

以上により、「経路特定区間を考慮したJR最長O型ルート」は、南岩国-下松間の任意の駅を発着駅とした、運賃計算キロ8081.4kmである、という**仮の最終結論**が得られました。

なぜ「仮」かといえば、求められた経路が、他の旅客営業規則などに抵触している可能性の考察です。

そしてこれは、最終的には人力検討を行うしかありません。

Windows版で算出した地図を合成したものの流用で申し訳ありませんが、

<img src="https://raw.githubusercontent.com/yonezawaizumi/lop-toolkit/master/data/honshu-longest-result%E2%88%92202003/images/image3.jpeg" alt="JR最長O型ルート">

このルートに対し、各特例に関する問題がないかどうかを検証します。

### 経路特定区間(旅規６９条)

すでに前章までで制約式として取り込み済ですが、重複適用がないかどうかをいちおう検証した結果、以下のとおり問題ありません。

| 号 | 経路 | 状態 |
| :---: | --- | --- |
| 2 | 尾久・王子 | 田端→赤羽→日暮里と通過しており、旅基109条適用 |
| 3 | 東北・埼京 | 南浦和→大宮→武蔵浦和と通過しており、旅基109条適用 |
| 4 | 東海道・品鶴 | いっさい通過せず |
| 5 | 総武・京葉 | 錦糸町→千葉→…→蘇我→東京と通過しており、旅基109条適用 |
| 6 | 北陸・湖西 | 草津→米原→近江塩津→山科と通過しており、旅基109条適用 |
| 7 | 大阪環状 | 天王寺→新今宮→大阪→京橋と通過しており、旅基109条適用 |
| 8 | 山陽・呉 | いっさい通過せず |
| 9 | 山陽・岩徳 | 特例考慮済み |

### 電車大環状線(旅規70条)

ぱっと見で明らかですが、西国分寺→新宿→田端→赤羽→日暮里→秋葉原→錦糸町→佐倉と1回通過した後、蘇我→東京→神田→代々木→品川→新横浜と通過しているため、旅基109条適用で、経路どおりの発券が可能であり、問題ありません。

### それ以外の、乗車券券面経路にかかわる特例

以下のとおり、再考の必要がありません。

* 特定都区市内(旅規86条)
    * すでに南岩国-下松間の駅が発着駅と定まっているため、関係ありません。
* 新大阪・大阪駅発着(旅規88条)
    * 前項と同様に、関係ありません。
* 北新地発着(旅規89条）
    * 前項と同様に、関係ありません。
* 新在別線原則の例外の例外(旅規64条4項3号)
    * JR九州が経路に含まれないため、関係ありません。
* 大都市近郊区間内相互発着(旅規157条2項)
    * 明らかに相互発着ではないため、関係ありません。
* それ以外の特例
    * 以下のものはすべて、最長ルートに関連する場合に限れば、乗車時に適用され得る特例であるため、乗車券発券時の最長ルートには関係しません。
        * 選択乗車(旅規157条)
        * 列車特定区間(旅基110条)
        * 特定分岐区間(旅基149条)
        * 分岐駅通過(旅基151条)
        * 折り返し列車(旅基152条)

### いわゆる日暮里・鶴見問題

デスクトップ鉄さん命名の[日暮里・鶴見問題](http://www.desktoptetsu.com/saichohensen.htm#nippori)は、「規則上片道乗車券の発売に問題はないが、その最長片道乗車券のみではじっさいの乗車を行うことができない」という、制度ヲタの間で「グレーゾーン」とされる「ことがある」未解決問題です。

相鉄・JR直通線開業にともなう旅客営業取扱基準規程の改変により、現在はこの「グレーゾーン」は、以下の経路において発生し得ます。

* 西日暮里以遠-日暮里-尾久-赤羽以遠
* 品川以遠-武蔵小杉-鶴見-川崎以遠または国道以遠

本件、対応するかどうかは「実乗時の流儀」の範疇です。たとえば、前述の「分岐駅通過特例」を「実乗時に使い、実乗キロ数をさらに上積みさせる」などと同じことになるかと思います。

* ちなみに筆者個人の実乗時の流儀は以下のとおりです
    * 最長乗車券での実乗
        * 特例の利用によって実乗キロ数を増やすことはいっさいしない
        * 日暮里鶴見問題は極力回避を試みるが、どうしても回避できない場合は、乗車できない経路について分岐往復乗車として運賃を支払い乗車する
    * 大都市近郊区間内の選択乗車（いわゆる「大回り」）での最長ルートの実乗の場合
        * 特例を最大限用い、実乗キロ数最大となるようにルートを算出する（[→例](http://feelfine.blog.izumichan.com/article.php?id=57984)）
        * 日暮里鶴見問題は、実乗時に回避できる選択乗車を行える限り、堂々と購入し利用する（[→例](https://youtu.be/hnM8lMWUPpA?t=193)）

ただしもちろん、これは「流儀」の問題ですから、「日暮里・鶴見問題に抵触する乗車券は、それ単独では実乗できない以上、最長片道切符と呼べないのではないか？」という見解も採り得ます。

そしてもちろん、「最長片道ルート全般において、日暮里鶴見問題を回避する」ことは、制約式として表現可能です。いうまでもなく、前述の2経路そのものを通過することを禁止すればこと足ります。

```
s.t. nippori_safe: e166 + e168 <= 1;
s.t. tsurumi_safe: e186 + e501 + e188 <= 2;
```

* もっとも、鶴見については、この経路を通る場合、東海道本線（トウカ）を品川まで利用できないため、O型ルートがこれを満たすことはありえないことは明らかです。

なお、本題である「JR最長O型」については、ここまででじっさいに得られた最長経路が、いずれの条件も満たしていないため、仮に「回避の前提」であったとしても、結果として最長だと言えます。

* もし仮に、日暮里駅において何らかの最長ルートがこの条件を満たし、かつ経路特定区間内発着にすることでキロ数を上積みできるような場合、券面キロ数最長のためには、日暮里-上野間の分岐往復の別途支払いが必須となることになります。

## 結論

以上により、「経路特定区間を考慮したJR最長O型ルート」は、南岩国-下松間の任意の駅を発着駅とした、運賃計算キロ8081.4kmである、という**真の最終結論**が得られました。

