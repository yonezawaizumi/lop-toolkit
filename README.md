# LOP toolkit for macOS & type O

## 概要

このリポジトリーは、史上はじめて最長片道切符のルートを数学的に厳密に求め、じっさいに購入して旅行した葛西隆也さん（SWAさん）がおんみずから制作し配布しているLOP toolkitに対し、以下の改造を施したものを、葛西さんの許諾を得て公開するものです。

* いわゆる「最長O型ルート」の計算に必要なロジックを追加した
* 文字コードをUTF-8にした
* macOS Catalinaで動作するようにした
* Perl v5.12以降で動作しなくなる問題を修正した
* PostScriptファイル生成時の不具合に応急処置を行った
* 本州用の地図ファイルを、2020年時点のものにアップデートした

なお、このリポジトリーを整備し公開した直接のきっかけである、「JR最長O型きっぷ」の計算および結果については、 `data/honshu-longest-result-202003/` 以下をご覧ください。詳細なテキストも置いてあります。

## 必要な環境

* macOS （たぶんどのバージョンでも動きます）
* GLPK （最新版でよいです）
* bashスクリプトを自力で修正できる脳
* 自力で地図データおよび路線データを作成できる脳
* 「最長片道切符のルートを求めること」は、「整数計画法の問題を解く」＋「旅客営業制度に精通しそれを制約式に落とし込む」である、と理解しそれを実行させるデータを記述できる脳

## ディレクトリー構成

    <docroot>/
    　├ original-sjis/
    　| 　├ manual/
    　| 　└ sample/
    　└ data/
    　  　└ honshu-longest-result-202003/

本家が「実行ファイル・実行スクリプト・全データファイルを同一ディレクトリーに置いて実行する」という前提なので、それを踏襲しています。

ルートディレクトリには、実行用の各種スクリプトが置かれています。

`original-sjis` には、葛西さんが配布しているオリジナルファイル（[このリンク先に直リンクがあります](https://www.swa785.net/lop/lop_a032.html#download)）を展開したものを、文字コード・改行コードを変更せずそのまま格納してあります。

`data` には、計算に用いる地図データおよび路線データを置いてあります。  
現状、本州内のJR線地図（2020年3月現在の路線について、不足はなく、一部廃止された路線が含まれています（路線データが廃止路線を含まない限り、計算結果に影響はありません）。

`honshu-longest-result-202003` には、とりあえず「2020年3月現在のJR最長O型きっぷ」の計算結果およびそのくわしい解説を格納してあります。

## 準備

1. GLPKのインストール
    * Homebrewからインストールできます
        * `brew install glpk`

1. 地図データの作成
    * `original-sjis/manual/` 以下にある各ファイルを熟読する
    * `maps.txt` に沿って、地図データを作成する
    * `original-sjis/sample/` も参考になる
    * ***macOSにおいて、現在のスクリプトの構成では、地図に多バイト文字を含めることができない***
        * Ghostscriptのフォント設定めんどい…
    * ***よって、地図に表示するラベルは、ASCII文字に限るべし***

1. 路線データの作成
    * CSVファイルとして作成する
    * 営業キロないし運賃計算キロを10倍した整数値を評価関数に与えるように設定する
    * `original-sjis/sample/edgeshon.csv` や `data/edges_*_2020.csv` が参考になる
    * 葛西さんが配布している、[JR運賃計算ツール MARS](https://www.swa785.net/pub/mars/index.html)のデータファイルから生成することもできる
        * ただしその場合、地図データとの整合性をとる必要がある

## 実行（O型入門編）

1. 地図データおよび路線データを、ドキュメントルートの全スクリプトとともに、同じディレクトリーに配置する
1. 最長O型ルートを計算する場合、 `autoo.sh` を実行する
    ~~~
    bash autoo.sh east_2020 lophonsh2020.txt
    ~~~  
    シェルスクリプトの第1引数として、路線データファイルの拡張子を除去したものを指定する  
    第2引数には、地図データのファイル名を指定する
1. 最終的にスクリプトが正常終了し、標準出力に最長ルートのキロ程が出力され、 `res_<第1引数>.ps` というPostScriptファイルにルートの結果の地図が出力される
1. PostScriptファイルは、macOS標準のプレビューアプリで表示可能である
1. 結果として `<第1引数>.otype.txt` というファイルが出力されるが、このファイルは、「孤立ループ」を除去した記録となる
    * 大きなループを除去した結果求められた最長解が、その大きなループよりも短くなる可能性を排除できない
    * 計算結果として「除去したループ」のすべてをログ出力し、最終結果がこれらよりも長いことを検討できるようにした

## 実行（O型実践編）

* じっさいに `autoo.sh` を実行すると、「本州全体を一括で求める」などのケースで、実用時間内では結果が得られないことがある
* また、旅客営業制度上の制約式を加味することは、 `autoo.sh` のみでは不可能である
* `auto.sh` がまさにそのために用意されている（というか本来はこれがLOP toolkitのバッチファイルの正当な移植である） 
* `auto.sh` は、GLPKに食わせるデータを生成せず、既存のデータから計算を開始するため、「手動で制約式を追加し計算を再開する」ことができる
* `autoo.sh` の実行結果（標準出力）がなかなか収束していない、と見受けられる場合、スクリプトの実行を中断し、以下の最適化を手動で行う
    * `res_<第1引数>.ps` ファイルを観、ヒューリスティックな制約式を検討する
    * `<第1引数>.mod` ファイルを開き、 `/* Section 9: heuristics */` の下に、前述の制約式を追記する
    * `auto.sh` スクリプトを実行する
        ~~~
        bash auto.sh east_2020 O lophonsh2020.txt
        ~~~
    * 第1引数および第3引数は `autoo.sh` と同一である
    * 第2引数には、計算ルートの型を指定する

## 実行（O型応用編）

* 以上の工夫を行ってもなお計算が収束しない場合、以下の戦略を採ることが望ましい
    * 計算範囲を、「両側を接続するルートが最小となるような箇所」で2分割する
    * 分割した接点のうちの2点を通過する、Leeルートをそれぞれ計算する
    * 分割した両側で、各接点で接続する最長ルートの合計を計算する
    * 分割した両側の片方で完結するO型最長ルートを計算する
    * これらすべての中で最長となるルートが、最長O型ルートである
* そのために、Leeルートの最長解を求めるシェルスクリプト `autolee.sh` を用意した

## 今後の展望

* 正直、まだまだ手作業が数多く残っている
* これらをまとめるには、「孤立ループを含む1度の計算」のリピートをすべてメモリー上に記録し、最適解の算出を簡略化することが望まれる

## 謝辞

本件、葛西さんの偉大過ぎる成果とその開示がなければ、成り立たないことです。
なによりも、葛西さんに、感謝感激尊敬畏怖のすべてを感じます。
以下の葛西さんによる発信をご参照ください。

    * [最長片道きっぷの経路を求める](https://www.swa785.net/lop/)
    * [じっさいに購入して旅行した Project LOP](https://www.swa785.net/plop/index.html)
