地図関係のメモ

■ 概要

　最長片道きっぷの経路を地図として表示・印刷するにあたり、地図を
表現するためのファイル形式、大げさに言えば「ベクトル画像フォーマ
ット」を２つ制定しました。１つは「駅」や「線路」などを直接的に表
現する論理的なもの、もう１つは単に「点」や「線」をテキストで表現
する物理的なものです。前者を「TXT 形式」、後者を「SW 形式」と呼
んでいます（まぎらわしい名前ですが、もともと公開するつもりのない
「自分用形式」なので、特に改名する気はありません）。
　TXT 形式を SW 形式へ変換するためのスクリプトを用意しています。
また、SW 形式を Postscript 形式へ変換するためのスクリプトも用意
しており、実際の画面表示や印刷は Postscript 形式のファイルを扱う
ツール（Ghostscript など）を用いることにしています（自前の画像表
示・印刷ツールは制作していません）。


■ 作業の流れ

　実際の作業は

	1. TXT 形式で地図を作成
	2. 最長経路を計算
	3. TXT 形式の地図に計算結果を反映（使う線路を赤く塗る）
	4. TXT→SW→Postscript と変換して画面などに出力

という流れになります。3. の「地図に計算結果を反映」する部分に関
してもスクリプトを用意しています。

　地図（路線図）に関しては、ＪＲ線のものは準備済みなので、新たに
作成する必要はありません。ただ、北海道、本州、四国、九州とそれぞ
れ別ファイルになっているので、全国を１枚にまとめたものなど、もっ
と凝ったものを自分で作りたいと思ったら自分で作ってください（TXT 
形式の仕様は後述します）。

　最長経路を計算したら、その結果を「coloring.pl」というスクリプ
トに食わせると、既存の地図に色がつきます（通る線路を赤くする）。

    perl coloring.pl <地図.txt> <計算結果.txt> > <色つき地図.txt>

　出てきた「色つき地図」を画面で確認するには、「txt2sw.pl」でい
ったん SW 形式に変換してから、それを「sw2ps.pl」で Postscript 形
式に変換して、Ghostscript なり GSView なりで見ます。

    perl txt2sw.pl <色つき地図.txt> | perl sw2ps.pl > <色つき地図.ps>

　3. と 4. をまとめて行うこともできます。

    perl coloring.pl <地図.txt> <計算結果.txt> | perl txt2sw.pl
                     | perl sw2ps.pl > <色つき地図.ps>

　これだけ見ると SW 形式は単なる中間ファイルなので不要という気も
しますが、きれいな地図を作るときに図形を微調整したいことがあるの
で、あえて残してあります。（ただ「TXT 形式→SW 形式→Postscript 
形式」という流れは一方通行で、逆向きの変換は行えないので、SW 形
式の微調整は計算が完全に終わってからやるのがよいでしょう。


■ TXT 形式の仕様

(1) 座標系について
　画面（紙面）上ではＸ軸が左右方向（左＜右）、Ｙ軸が上下方向（上
＜下）です。左上が原点 (X,Y)=(0,0) ということになります。
　おおむね (0,0)-(560,840) の範囲に描画するとＡ４縦の用紙におさ
まります。

(2) 駅記述部
　駅の座標、および駅名の描画位置を指定します。１行に１駅を記載し
ます。(3) より先に記述するのが無難です。指定した座標には、駅を表
す「●」が描画されます。

[書式]
<Ｘ座標>,<Ｙ座標>,<駅(頂点)番号>,<駅名>,[駅名描画位置]

・駅(頂点)番号→駅間に線を引くのに使います。分かりやすさのため、
  制約式ファイルと同じ番号体系にしておいたほうがいいでしょう。
・駅名→すべて２バイト文字を想定しています。
・駅名描画位置→駅を表す「●」に対してどちら側に駅名を描画するか
  を表します。1＝右、2＝上、3＝左、4＝下で、これらに＋4すると縦
  書きになります。また、0 を指定すると駅名を描画しません。

(3) 線路記述部
　指定した条件で、線路を表す直線を描画します。
　書式は２種類あります。

[書式１]
L,<駅(頂点)番号１>,<駅(頂点)番号２>,<線路(枝)番号>,[色]

・「駅(頂点)番号１」と「駅(頂点)番号２」を結ぶ線路を描きます。
・線路(枝)番号→制約式ファイルと同じ番号体系にしておきます。たと
  えば、制約式ファイルの e123 という変数に対応する線路には「123」
  という番号をつけておきます。
・色→0＝黒、1＝赤です。無指定だと黒です。coloring.pl はここで指
  定した色を無視して色情報を上書きします。

[書式２]
l,<駅(頂点)番号>,<Ｘ座標>,<Ｙ座標>,<線路(枝)番号>,[色]

・「駅(頂点)番号」と点 (X,Y) を結ぶ線路を描きます。

(4) 文字記述部
　指定した位置に文字列を描画します。

[書式]
t,<Ｘ座標>,<Ｙ座標>,<文字サイズ>,<文字列>
e,<Ｘ座標>,<Ｙ座標>,<文字サイズ>,<文字列>

・「t」で始まる場合には２バイト文字を、「e」で始まる場合には１バ
  イト文字を (X,Y) から描画します。


■ SW 形式の仕様

　以下の要素を順不同で記述します。
　なお、SW 形式の座標の原点は画面（紙）の左下です。また、各行の
「#」以降の文字はコメントとみなします。

[書式]
dot,<Ｘ座標>,<Ｙ座標>,<サイズ>
（「●」の描画、「サイズ」で半径指定）

japanese,<Ｘ座標>,<Ｙ座標>,<サイズ>,<文字列>
（横書き２バイト文字列の描画）

english,<Ｘ座標>,<Ｙ座標>,<サイズ>,<文字列>
（横書き１バイト文字列の描画）

bline,<Ｘ座標１>,<Ｙ座標１>,<Ｘ座標２>,<Ｙ座標２>
（黒い直線の描画）

rline,<Ｘ座標１>,<Ｙ座標１>,<Ｘ座標２>,<Ｙ座標２>
（赤い直線の描画）

